package templates

import (
	"fmt"
	"strings"

	"github.com/boozedog/smoovtask/internal/ticket"
)

func priorityClass(p ticket.Priority) string {
	return "uk-badge st-priority-" + strings.ToLower(string(p))
}

func statusClass(s ticket.Status) string {
	return "st-status-" + strings.ToLower(string(s))
}

func statusBadgeClass(s ticket.Status) string {
	switch s {
	case ticket.StatusDone:
		return "st-status-badge-done"
	case ticket.StatusCancelled:
		return "st-status-badge-cancelled"
	case ticket.StatusBlocked, ticket.StatusRework:
		return "uk-badge-destructive"
	case ticket.StatusInProgress, ticket.StatusReview:
		return "uk-badge-primary"
	default:
		return "uk-badge-secondary"
	}
}

func statusLabel(s ticket.Status) string {
	return string(s)
}

func shortAssignee(s string) string {
	if s == "" {
		return ""
	}
	// Truncate UUIDs to first 8 chars.
	if len(s) > 8 && s[8] == '-' {
		return s[:8]
	}
	// Handle prefixed formats like ses_..., prefix_value
	if idx := strings.Index(s, "_"); idx > 0 && idx < len(s)-1 {
		value := s[idx+1:]
		if len(value) >= 8 {
			return value[:8]
		}
		return value // if value <8, show full
	}
	// Fallback: if longer than 12 chars, truncate to 8 with ellipsis
	if len(s) > 12 {
		return s[:8] + "..."
	}
	return s
}

func assigneePillColor(s string) string {
	if len(s) > 8 && s[8] == '-' {
		return "hsl(var(--warning))" // warning tone for Claude Code UUIDs
	}
	if strings.Contains(s, "_") {
		return "hsl(var(--primary))" // primary tone for prefixed IDs (opencode/pi)
	}
	return "hsl(var(--secondary))" // secondary tone default
}

func showAssignee(tk *ticket.Ticket) bool {
	return tk.Assignee != "" &&
		(tk.Status == ticket.StatusInProgress || tk.Status == ticket.StatusReview)
}

func sourceLabel(source string) string {
	switch source {
	case "claude":
		return "Claude"
	case "opencode":
		return "OpenCode"
	case "pi":
		return "PI"
	default:
		return "Unknown"
	}
}

func sourceGlyph(source string) string {
	switch source {
	case "claude":
		return "ðŸ¦€"
	case "opencode":
		return "â–£"
	case "pi":
		return "â—‰"
	default:
		return "\uf059"
	}
}

templ PriorityBadge(p ticket.Priority) {
	<span class={ priorityClass(p) }>{ string(p) }</span>
}

templ StatusBadge(s ticket.Status) {
	<span class={ "uk-badge " + statusBadgeClass(s) }>
		{ statusLabel(s) }
	</span>
}

templ SourceBadge(source string) {
	if source != "" {
		<span class="inline-flex items-center gap-1 text-xs opacity-70" title={ sourceLabel(source) }>
			if source == "claude" {
				<img src="/static/claude-crab.png" alt="Claude" class="st-source-badge-image"/>
			} else {
				<span class="st-source-glyph">{ sourceGlyph(source) }</span>
				<span>{ sourceLabel(source) }</span>
			}
		</span>
	}
}

templ TicketCard(tk *ticket.Ticket, source string) {
	<a href={ templ.SafeURL(fmt.Sprintf("/ticket/%s", tk.ID)) } hx-get={ fmt.Sprintf("/partials/ticket/%s", tk.ID) } hx-target="#ticket-modal-body" class="uk-card uk-card-body st-ticket-card">
		if tk.Project != "" {
			<div class="text-[0.65rem] opacity-50 leading-none">{ tk.Project }</div>
		}
		<div class="uk-card-title st-card-title">{ tk.Title }</div>
		<div class="text-xs opacity-70 flex gap-2 items-center">
			@PriorityBadge(tk.Priority)
			<span>{ tk.ID }</span>
		</div>
		if source != "" || showAssignee(tk) {
			<div class="mt-1 flex items-center justify-between gap-2">
				@SourceBadge(source)
				if showAssignee(tk) {
					<span class="st-assignee-wrap">
						<span class="st-session-dot"></span>
						<span title={ tk.Assignee } class="st-assignee-pill" style={ "--st-assignee-bg: " + assigneePillColor(tk.Assignee) + ";" }>{ shortAssignee(tk.Assignee) }</span>
					</span>
				}
			</div>
		}
	</a>
}
