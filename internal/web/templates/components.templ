package templates

import (
	"fmt"
	"strings"

	"github.com/boozedog/smoovtask/internal/ticket"
)

func priorityClass(p ticket.Priority) string {
	return "st-badge st-badge-" + strings.ToLower(string(p))
}

func statusClass(s ticket.Status) string {
	return "st-status-" + strings.ToLower(string(s))
}

func statusLabel(s ticket.Status) string {
	return string(s)
}

func shortAssignee(s string) string {
	if s == "" {
		return ""
	}
	// Truncate UUIDs to first 8 chars.
	if len(s) > 8 && s[8] == '-' {
		return s[:8]
	}
	// Handle prefixed formats like ses_..., prefix_value
	if idx := strings.Index(s, "_"); idx > 0 && idx < len(s)-1 {
		value := s[idx+1:]
		if len(value) >= 8 {
			return value[:8]
		}
		return value // if value <8, show full
	}
	// Fallback: if longer than 12 chars, truncate to 8 with ellipsis
	if len(s) > 12 {
		return s[:8] + "..."
	}
	return s
}

func assigneePillColor(s string) string {
	if len(s) > 8 && s[8] == '-' {
		return "#f97316" // orange for Claude Code UUIDs
	}
	if strings.Contains(s, "_") {
		return "#3b82f6" // blue for prefixed IDs (opencode/pi)
	}
	return "#22c55e" // default green
}

func showAssignee(tk *ticket.Ticket) bool {
	return tk.Assignee != "" &&
		(tk.Status == ticket.StatusInProgress || tk.Status == ticket.StatusReview)
}

func sourceLabel(source string) string {
	switch source {
	case "claude":
		return "Claude"
	case "opencode":
		return "OpenCode"
	case "pi":
		return "PI"
	default:
		return "Unknown"
	}
}

func sourceGlyph(source string) string {
	switch source {
	case "claude":
		return "ðŸ¦€"
	case "opencode":
		return "â–£"
	case "pi":
		return "â—‰"
	default:
		return "\uf059"
	}
}

templ PriorityBadge(p ticket.Priority) {
	<span class={ priorityClass(p) }>{ string(p) }</span>
}

templ StatusBadge(s ticket.Status) {
	<span class={ "st-badge " + statusClass(s) } style="border: 1px solid; background: transparent;">
		{ statusLabel(s) }
	</span>
}

templ SourceBadge(source string) {
	if source != "" {
		<span class="inline-flex items-center gap-1 opacity-70" title={ sourceLabel(source) } style="font-size: 0.75rem;">
			if source == "claude" {
				<img src="/static/claude-crab.png" alt="Claude" style="height: 1.5rem; width: auto; image-rendering: pixelated;"/>
			} else {
				<span style="font-family: 'Maple Mono NF', monospace;">{ sourceGlyph(source) }</span>
				<span>{ sourceLabel(source) }</span>
			}
		</span>
	}
}

templ TicketCard(tk *ticket.Ticket, source string) {
	<a href={ templ.SafeURL(fmt.Sprintf("/ticket/%s", tk.ID)) } hx-get={ fmt.Sprintf("/partials/ticket/%s", tk.ID) } hx-target="#ticket-modal-body" class="st-card">
		if tk.Project != "" {
			<div style="font-size: 0.65rem; opacity: 0.5; line-height: 1; margin-bottom: 0.05rem;">{ tk.Project }</div>
		}
		<div class="st-card-title">{ tk.Title }</div>
		<div class="st-card-meta">
			@PriorityBadge(tk.Priority)
			<span>{ tk.ID }</span>
		</div>
		if source != "" || showAssignee(tk) {
			<div class="mt-1 flex items-center justify-between gap-2">
				@SourceBadge(source)
				if showAssignee(tk) {
					<span title={ tk.Assignee } class="inline-block rounded-full font-semibold" style={ "padding: 0.1rem 0.4rem; font-family: 'Maple Mono NF', monospace; font-size: 0.65rem; margin-left: auto; background: " + assigneePillColor(tk.Assignee) + "; color: #000;" }>{ shortAssignee(tk.Assignee) }</span>
				}
			</div>
		}
	</a>
}
